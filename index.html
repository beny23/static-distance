<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Help Out Eat Out To Help Out</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.6.0/leaflet.css"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.72.0/dist/L.Control.Locate.min.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Karla:400,700|Martel:400,700">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.6.0/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.72.0/dist/L.Control.Locate.min.js" charset="utf-8"></script>    <!-- Make sure you put this AFTER Leaflet's CSS -->
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <style>
        #mapid {
            width: 95%;
            height: 500px;
        }
        body {
            font-family: 'Martel', serif;
            font-weight: 400;
            background-color: #C5D0DD;
            color: #2B394A;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: 'Karla', sans-serif;
            font-weight: 700;
        }

        .button {
            font-family: 'Karla', sans-serif;
            font-weight: 700;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 3px;
        }

        #coords {
            display: flex
        }

        #coords div {
            padding-right: 15px;
        }
    </style>
    <!-- Google Analytics -->
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-171035600-1', 'auto');
        ga('send', 'pageview');
    </script>
    <!-- End Google Analytics -->
</head>
<body>
    <h1><img src="eotho.png" alt="Eat Out to Help Out"/> Discounted Dining Finder</h1>
    <p>
        Use this to find participants of the
        <a href="https://www.gov.uk/guidance/get-a-discount-with-the-eat-out-to-help-out-scheme">Eat Out to Help Out</a>
        scheme. Uses the HMRC <a href="https://github.com/hmrc/eat-out-to-help-out-establishments">published data set</a>.
        Read <a href="/posts/discounted_dining_finder/">how it was built</a>.
    </p>
    <form onsubmit="search(); return false;">
        <label for="postcode">Enter postcode</label>
        <input id="postcode" type="text">
        <input id="submit" type="submit" value="Search">
    </form>

    <div id="status"></div>
    <div id="coords">
        <div>Longitude: <span id="longitude"></span></div>
        <div>Latitude: <span id="latitude"></span></div>
    </div>
    <div id="mapid"></div>
    <div>
        <table>
            <thead>
            <tr><th>Name</th><th>Postcode</th><th>Distance</th></tr>
            </thead>
            <tbody id="results"></tbody>
        </table>
    </div>

    <script>

        POSTCODE_REGEX = new RegExp("^((GIR ?0AA)|((([A-Z][0-9]{1,2})|(([A-Z][A-HJ-Y][0-9]{1,2})|(([A-Z][0-9][A-Z])|([A-Z][A-HJ-Y][0-9][A-Z]?))))\\s?[0-9][A-Z]{2}))$")

        mapid = L.map('mapid');
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(mapid);
        markerLayer = L.layerGroup().addTo(mapid)

        mapid.on("moveend", function () {
            var d = mapid.getCenter();
            var result = { lat: d.lat, lon: d.lng };

            d3.select("#longitude").text(result.lon.toFixed(3));
            d3.select("#latitude").text(result.lat.toFixed(3));

            var x = parseInt((+result.lat - 49.0) / (12.0 / 160.0))
            var y = parseInt((+result.lon + 9) / (11.0 / 80.0))

            d3.csv("pubgrid/" + x + "/" + x + "-" + y + ".csv")
                .then(function(pubs) {
                    let inRange = pubs
                        .map(a => ({ ...a, distance: distance(result, a)}))
                        .filter(a => a.distance < (5 * 1609.34))
                        .sort((a, b) => a.distance - b.distance)
                        .slice(0, 250)

                    d3.select("#results").selectAll("tr")
                        .data(inRange)
                        .join("tr")
                        .selectAll("td")
                        .data(d => [ d.name, "<a href=\"javascript:goto('" + d.postcode + "')\">" + d.postcode + "</a>", (d.distance / 1609.34).toFixed(2) + " miles away" ])
                        .join("td")
                        .html(d => d)

                    markerLayer.clearLayers();
                    inRange.forEach(d => L.marker([d.lat, d.lon], { "title": d.name })
                        .bindPopup(escapeHtml(d.name) + "<br>" + d.postcode)
                        .addTo(markerLayer))
                })
        });

        mapid.setView([51.505, -0.09], 15);
        L.control.locate({drawCircle: false, keepCurrentZoomLevel: true}).addTo(mapid);

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function goto(postcode) {
            d3.select("#postcode").property("value", postcode);
            search();
            return false;
        }

        function search() {
            postcode = normalisePostcode(d3.select("#postcode").property("value"));

            d3.select("#results").text("")

            if (!postcode.match(POSTCODE_REGEX)) {
                d3.select("#status").text("Invalid postcode");
            } else {
                d3.select("#status").text("Searching...");
                outcode = postcode.slice(0, -3);

                d3.csv("outcode/" + outcode[0] + "/" + outcode[1] + "/" + outcode + ".csv")
                    .then(function(postcodes) {
                        result = postcodes.find(d => normalisePostcode(d.postcode) === postcode);
                        if (result) {
                            d3.select("#status").text("");
                            mapid.panTo(new L.LatLng(result.lat, result.lon));
                        } else {
                            d3.select("#status").text("Postcode not found")
                        }
                    })
            }
        }

        function normalisePostcode(postcode) {
            return postcode.replace(" ", "").toUpperCase()
        }

        function distance(p1, p2) {
            const R = 6371e3; // metres
            const φ1 = p1.lat * Math.PI/180; // φ, λ in radians
            const φ2 = p2.lat * Math.PI/180;
            const Δφ = (p2.lat-p1.lat) * Math.PI/180;
            const Δλ = (p2.lon-p1.lon) * Math.PI/180;

            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                Math.cos(φ1) * Math.cos(φ2) *
                Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c
        }
    </script>

</body>
</html>