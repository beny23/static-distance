<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-171035600-2"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-171035600-2');
    </script>

    <meta charset="UTF-8">
    <meta name="Description" content="Search restaurants participating in the Eat Out to Help Out scheme. Search by postcode, town or village name on a zoom/draggable map. And it's open source.">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <meta property="og:title" content="Discounted Dining Finder: Places to Eat Out To Help Out"/>
    <meta property="og:image" content="https://www.eat-out-to-help-out.co/eotho.png"/>
    <meta property="og:description" content="Search restaurants participating in the Eat Out to Help Out scheme. Search by postcode, town or village name on a zoom/draggable map. And it's open source."/>
    <meta property="og:url" content="//www.example.com/URL of the article"/>
    <meta property="og:type" content="website" />

    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Discounted Dining Finder">
    <meta name="twitter:description" content="Search restaurants participating in the Eat Out to Help Out scheme. Search by postcode, town or village name on a zoom/draggable map. And it's open source.">

    <title>Discounted Dining Finder: Places to Eat Out To Help Out</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.6.0/leaflet.css" integrity="sha384-eS4bw6aEvhCSXWGP85ANR/N8isWKzT7P36NvcuTJGkrj6wsbxLVpXslrNXYHyseD" crossorigin="anonymous"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.72.0/dist/L.Control.Locate.min.css" integrity="sha384-vPNGCZwbWwO+u7VXCcmLEJRcz/YmtXGdC3LOF8O4/IvddhfpYZI1O0tJszYkbsD2" crossorigin="anonymous"/>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" integrity="sha384-bF2gXog8EbftpjuWQY8G0T7aeq+FvNU9YWvxSRHybqv2F/lvV5msKMHvRgoukeQP" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.4.1/MarkerCluster.css" integrity="sha512-RLEjtaFGdC4iQMJDbMzim/dOvAu+8Qp9sw7QE4wIMYcg2goVoivzwgSZq9CsIxp4xKAZPKh5J2f2lOko2Ze6FQ==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.4.1/MarkerCluster.Default.css" integrity="sha512-BBToHPBStgMiw0lD4AtkRIZmdndhB6aQbXpX7omcrXeG2PauGBl2lzq2xUZTxaLxYz5IDHlmneCZ1IJ+P3kYtQ==" crossorigin="anonymous" />

    <script src="https://polyfill.io/v3/polyfill.min.js?features=Array.prototype.find%2Cfetch%2CPromise%2CPromise.prototype.finally%2Cdefault%2CArray.prototype.includes" integrity="sha384-bF2gXog8EbftpjuWQY8G0T7aeq+FvNU9YWvxSRHybqv2F/lvV5msKMHvRgoukeQP" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.6.0/leaflet.js" integrity="sha384-wKOriz2x8/bF1D9t6PuKhSpxfhHeVi9huvyuxJrrShSJpi5+rmRIsM90UuWbdAYJ" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.72.0/dist/L.Control.Locate.min.js" integrity="sha384-g5auForUrJRA/c7ecPwFWRKeQqsJphdlumGoxbKTX6tpzREZyXRzeGwqjenHr4Yx" crossorigin="anonymous" charset="utf-8"></script>    <!-- Make sure you put this AFTER Leaflet's CSS -->
    <script src="https://d3js.org/d3.v5.min.js" integrity="sha384-M06Cb6r/Yrkprjr7ngOrJlzgekrkkdmGZDES/SUnkUpUol0/qjsaQWQfLzq0mcfg" crossorigin="anonymous"></script>
    <script src="leaflet-hash.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js" integrity="sha384-RLIyj5q1b5XJTn0tqUhucRZe40nFTocRP91R/NkRJHwAe4XxnTV77FXy/vGLiec2" crossorigin="anonymous"></script>
    <style>
        #mapid {
            position: relative;
            width: 100%;
            height: 90%;
        }
        html, body, div.container, div.tab-content, #map {
            position: relative;
            padding: 0;
            margin: 0;
            height: 100%;
        }
        .facebook, .twitter, .linkedin {
            fill: #BABABA;
        }
    </style>
</head>
<body>
<div class="container">
    <h1 class="collapse">Discounted Dining Finder: Places to Eat Out To Help Out</h1>
    <nav class="navbar navbar-light bg-light">
        <img class="navbar-brand" src="eotho.png" alt="Eat Out To Help Out">
        <ul class="nav nav-pills" role="tablist">
            <li class="nav-item">
                <a id="maplink" class="nav-link active" data-toggle="pill" href="#map">Map</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-toggle="pill" href="#list">List</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-toggle="pill" href="#about">About</a>
            </li>
        </ul>
        <form class="form-inline my-2 my-lg-0" onsubmit="return search(event)">
            <div class="input-group">
                <input id="postcode" class="form-control" type="search" placeholder="Postcode or town" aria-label="Search">
                <div class="input-group-append">
                    <button class="btn btn-outline-success" type="submit">Search</button>
                </div>
            </div>
        </form>
    </nav>
    <div id="notfound" class="alert alert-warning alert-dismissible collapse fade" role="alert">
        Location not found
        <button type="button" class="close" aria-label="Close" data-toggle="collapse" href="#notfound">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="tab-content">
        <div id="map" class="container tab-pane active">
            <div id="mapid"></div>
        </div>
        <div id="list" class="container tab-pane fade">
            <div class="table-responsive">
                <table class="table">
                    <thead>
                    <tr><th>Name</th><th>Postcode</th><th>Distance</th></tr>
                    </thead>
                    <tbody id="results"></tbody>
                </table>
            </div>
        </div>
        <div id="about" class="container tab-pane fade">
            <div id="sharing" class="d-flex flex-row-reverse">
                <a href="https://www.facebook.com/sharer.php?u=https://eat-out-to-help-out.co/" class="facebook no-underline" aria-label="share on Facebook">
                    <svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                        <path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"></path>
                    </svg>
                </a>
                <a href="https://twitter.com/share?url=https://eat-out-to-help-out.co/&amp;text=Discounted%20Dining%20Finder" class="twitter no-underline" aria-label="share on Twitter">
                    <svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                        <path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"></path>
                    </svg>
                </a>
                <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=eat-out-to-help-out.co/&amp;title=Discounted%20Dining%20Finder" class="linkedin no-underline" aria-label="share on LinkedIn">
                    <svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                        <path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30C64 50.568 50.568 64 34 64zM26.354 48.137V27.71h-6.789v20.427H26.354z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"></path>
                    </svg>
                </a>
            </div>
            <p>
                Use this tool to find participants of the
                <a href="https://www.gov.uk/guidance/get-a-discount-with-the-eat-out-to-help-out-scheme">Eat Out to Help Out</a>
                scheme.  You can search using a postcode (e.g. "M1" or "M4 4BF") or a town ("Manchester") or borough
                ("South Ribble").
            </p>
            <p>
                Use the Eat Out to Help Out Scheme at a participating establishment:
            </p>
            <ul>
                <li>to get a 50% discount on food or non-alcoholic drinks to eat or drink in (up to a maximum of £10 discount per diner)</li>
                <li>every Monday, Tuesday and Wednesday between 3 and 31 August</li>
                <li>as many times as you like</li>
            </ul>
            <p>
                You do not need a voucher to use this scheme and you can use it at the same time as other offers and
                discounts. There is no minimum spend.
            </p>
            <p>
                You cannot claim discount on alcoholic drinks or service charges.
            </p>
            <p>
                This tool uses the published <a href="https://github.com/hmrc/eat-out-to-help-out-establishments">data set</a> on
                the HMRC GitHub repository and is updated with the latest list of establishments daily.  Please note, the
                HMRC data set does not include larger chains, so some participating restaurants are not included in the search
                at the moment. This is a list of
                <a href="https://www.tax.service.gov.uk/eat-out-to-help-out/find-a-restaurant/restaurant-chains">Chain restaurants and large businesses</a>
                registered for the scheme.
            </p>
            <p>
                The direct links to the restaurant use a <a href="https://duckduckgo.com/">duckduckgo</a> search of the
                restaurant's name and postcode - which typically lands on the correct page, though not all establishments have
                been checked and there is no guarantee that it will find the right place.
            </p>
            <p>
                Read all about <a href="https://beny23.github.io/posts/discounted_dining_finder/">how it was built</a>.
            </p>
            <p>
                Also available as an app <a href="https://apps.apple.com/gb/app/discount-dining-finder/id1526826492" target="_blank" rel="noopener">
                <img alt="Download from the App Store" src="Download_on_the_App_Store_Badge.svg"></a>
            </p>
            <p>
                &copy; 2020 Software Design Systems Ltd
            </p>
        </div>
    </div>
</div>

<script>

    function escapeHtml(unsafe) {
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    function normalisePostcode(postcode) {
        return postcode.toUpperCase().replace(/[^A-Z0-9]/g, "");
    }

    function gotoPostcode(postcode) {
        $('#notfound').collapse('hide');
        $('#maplink').tab('show');
        d3.select("#postcode").property("value", postcode);
        window.scrollTo(0, 0);
    }

    function search(e) {
        e.preventDefault();

        const postcode = normalisePostcode(d3.select("#postcode").property("value"));
        const outcode = postcode.slice(0, 4);

        d3.csv("outcode/" + outcode[0] + "/" + outcode[1] + "/" + outcode + ".csv")
            .then(function(postcodes) {
                const result = postcodes.find(function(d) { return normalisePostcode(d.postcode) === postcode; });
                if (result) {
                    $('#notfound').collapse('hide');
                    mapid.panTo(new L.LatLng(result.lat, result.lon));
                } else {
                    $('#notfound').collapse('show');
                }
            })
            .catch(function(error) {
                console.log(error);
                $('#notfound').collapse('show');
            })
        return false;
    }

    function distance(p1, p2) {
        const R = 6371e3; // metres
        const phi1 = p1.lat * Math.PI/180; // φ, λ in radians
        const phi2 = p2.lat * Math.PI/180;
        const deltaphi = (p2.lat-p1.lat) * Math.PI/180;
        const deltal = (p2.lon-p1.lon) * Math.PI/180;

        const a = Math.sin(deltaphi/2) * Math.sin(deltaphi/2) +
            Math.cos(phi1) * Math.cos(phi2) *
            Math.sin(deltal/2) * Math.sin(deltal/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

        return R * c;
    }

    function makeDirectLink(d) {
        return "<a target=\"_blank\" href=\"https://duckduckgo.com/?q=%5C" + encodeURIComponent(d.name) + "%20" + encodeURIComponent(d.postcode) + "\">" + escapeHtml(d.name) + "</a>"
    }

    function showResults(inRange) {
        renderTable(inRange);
        renderMap(inRange);
    }
    function renderMap(inRange) {
        markerLayer.clearLayers();
        inRange.forEach(function(d) {
            return L.marker([d.lat, d.lon], {"title": d.name})
                .bindPopup(makeDirectLink(d) + "<br>" + d.postcode)
                .addTo(markerLayer)
        });
    }
    function renderTable(inRange, result) {
	    inRange = inRange
                    .map(function(a) {
                        return {
                            name: a.name,
                            postcode: a.postcode,
                            lat: a.lat,
                            lon: a.lon,
                            distance: distance(result, a)
                        };
                    })
		    .filter(function(a) {
				    return a.distance < (5 * 1609.34);
				    })
	    .sort(function(a, b) {
			    return a.distance - b.distance;
			    });
        d3.select("#results")
            .selectAll("tr")
            .data(inRange)
            .join("tr")
            .selectAll("td")
            .data(function(d) {
                return [
                    makeDirectLink(d),
                    "<a href=\"#" + mapid.getZoom() + "/" + d.lat + "/" + d.lon + "\" onclick=\"gotoPostcode('" + d.postcode + "')\">" + escapeHtml(d.postcode) + "</a>",
                    (d.distance / 1609.34).toFixed(2) + "mi"
                ];
            })
            .join("td")
            .html(function(d) { return d; });
    }

    const mapid = L.map('mapid');
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        minZoom: 11,
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(mapid);
    const markerLayer = L.markerClusterGroup({maxClusterRadius: 1}).addTo(mapid);
    let httpCache = {};

    var southWest = L.latLng(49, -9),
        northEast = L.latLng(61, 2);
    var bounds = L.latLngBounds(southWest, northEast);

    mapid.setMaxBounds(bounds);
    mapid.on('drag', function() {
        mapid.panInsideBounds(bounds, { animate: false });
    });

    mapid.on("moveend", function () {
        const d = mapid.getCenter();
        const result = { lat: d.lat, lon: d.lng };
        localStorage && localStorage.setItem('location', JSON.stringify({lon: d.lng, lat: d.lat, zoom: mapid._zoom}));

        const x = Math.round((+result.lat - 49.0) / (12.0 / 160.0));
        const y = Math.round((+result.lon + 9) / (11.0 / 80.0));
        let current = {"x": x, "y": y};
	if (httpCache.location && (JSON.stringify(httpCache.location) == JSON.stringify(current))) {
		renderTable(httpCache.pubs, result);
                return ;
	}
        d3.csv("pubgrid/" + x + "/" + x + "-" + y + ".csv")
            .then(function(pubs) {
                    renderTable(pubs, result);
                    renderMap(pubs);
                    httpCache = {location: current, pubs: pubs};
            })
            .catch(function(error) {
                showResults([]);
            });

    });

    let defaults = {
        lat: 51.505,
        lon: -0.09,
        zoom: 15
    }

    if (localStorage && localStorage.getItem('location')) {
        defaults = JSON.parse(localStorage.getItem('location'));
    }

    mapid.setView([defaults.lat, defaults.lon], defaults.zoom);
    L.control.locate({drawCircle: false, keepCurrentZoomLevel: true}).addTo(mapid);
    var hash = new L.Hash(mapid);

</script>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>
</body>
</html>
