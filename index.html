<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Static Distance Spike</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.6.0/leaflet.css"/>
    <!-- Make sure you put this AFTER Leaflet's CSS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.6.0/leaflet.js"></script>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <style>
        #mapid {
            height: 500px;
        }
    </style>
</head>
<body>
    <h1>Static Distance Spike</h1>
    <form onsubmit="search(); return false;">
        <label for="postcode">Enter postcode</label>
        <input id="postcode" type="text">
        <input id="submit" type="submit" value="Search">
    </form>

    <div id="status"></div>
    <div>Longitude: <span id="longitude"></span></div>
    <div>Latitude: <span id="latitude"></span></div>
    <div id="mapid"></div>
    <div>
        <table>
            <thead>
            <tr><th>Name</th><th>Postcode</th><th>Distance</th></tr>
            </thead>
            <tbody id="results"></tbody>
        </table>
    </div>

    <script>

        POSTCODE_REGEX = new RegExp("^((GIR ?0AA)|((([A-Z][0-9]{1,2})|(([A-Z][A-HJ-Y][0-9]{1,2})|(([A-Z][0-9][A-Z])|([A-Z][A-HJ-Y][0-9][A-Z]?))))\\s?[0-9][A-Z]{2}))$")

        mapid = L.map('mapid').setView([51.505, -0.09], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(mapid);
        markerLayer = L.layerGroup().addTo(mapid)

        mapid.on("moveend", function () {
            var d = mapid.getCenter();
            var result = { lat: d.lat, lon: d.lng };

            d3.select("#longitude").text(result.lon);
            d3.select("#latitude").text(result.lat);

            var x = parseInt((+result.lat - 49.0) / (12.0 / 160.0))
            var y = parseInt((+result.lon + 9) / (11.0 / 80.0))

            d3.csv("pubgrid/" + x + "/" + x + "-" + y + ".csv")
                .then(function(pubs) {
                    let inRange = pubs
                        .map(a => ({ ...a, distance: distance(result, a)}))
                        .filter(a => a.distance < (5 * 1600))
                        .sort((a, b) => a.distance - b.distance)
                        .slice(0, 500)

                    let tbody = d3.select("#results");
                    let rows = tbody.selectAll("tr").data(inRange).enter().append("tr")

                    rows.append('td').text(d => d.name)
                    rows.append('td').text(d => d.postcode)
                    rows.append('td').text(d => (d.distance / 1600).toFixed(2) + " miles away")

                    tbody.selectAll('tr').data(inRange).exit().remove()

                    markerLayer.clearLayers();
                    inRange.forEach(d => L.marker([d.lat, d.lon], { "title": d.name }).addTo(markerLayer))
                })
        });

        function search() {
            postcode = normalisePostcode(d3.select("#postcode").property("value"));

            d3.select("#results").text("")

            if (!postcode.match(POSTCODE_REGEX)) {
                d3.select("#status").text("Invalid postcode");
            } else {
                d3.select("#status").text("Searching...");
                outcode = postcode.slice(0, -3);

                d3.csv("outcode/" + outcode[0] + "/" + outcode[1] + "/" + outcode + ".csv")
                    .then(function(postcodes) {
                        result = postcodes.find(d => normalisePostcode(d.postcode) === postcode);
                        if (result) {
                            d3.select("#status").text("");
                            mapid.panTo(new L.LatLng(result.lat, result.lon));
                        } else {
                            d3.select("#status").text("Postcode not found")
                        }
                    })
            }
        }

        function normalisePostcode(postcode) {
            return postcode.replace(" ", "").toUpperCase()
        }

        function distance(p1, p2) {
            const R = 6371e3; // metres
            const φ1 = p1.lat * Math.PI/180; // φ, λ in radians
            const φ2 = p2.lat * Math.PI/180;
            const Δφ = (p2.lat-p1.lat) * Math.PI/180;
            const Δλ = (p2.lon-p1.lon) * Math.PI/180;

            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                Math.cos(φ1) * Math.cos(φ2) *
                Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c
        }
    </script>
</body>
</html>